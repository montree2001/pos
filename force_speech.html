<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î - ‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        h1 {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .queue-display {
            font-size: 5rem;
            font-weight: bold;
            color: #4ecdc4;
            margin: 30px 0;
            text-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #4ecdc4;
            border-radius: 15px;
            background: rgba(78, 205, 196, 0.1);
        }
        
        input {
            font-size: 2.5rem;
            padding: 20px;
            border: 3px solid #4ecdc4;
            border-radius: 15px;
            text-align: center;
            width: 250px;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        
        button {
            font-size: 1.3rem;
            padding: 15px 25px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .success { background: #2ecc71; color: white; }
        .error { background: #e74c3c; color: white; }
        .warning { background: #f39c12; color: white; }
        .info { background: #3498db; color: white; }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 20px;
        }
        
        .debug {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #0f0;
        }
        
        .voice-info {
            background: #34495e;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .progress {
            width: 100%;
            height: 10px;
            background: #555;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.3s;
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .glow {
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px #4ecdc4; }
            to { box-shadow: 0 0 20px #4ecdc4, 0 0 30px #4ecdc4; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîä ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß - ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</h1>
        
        <div class="queue-display glow" id="queueDisplay">-</div>
        
        <div>
            <input type="number" id="queueInput" placeholder="‡∏Ñ‡∏¥‡∏ß" min="1" max="999" value="1">
        </div>
        
        <div class="controls">
            <button onclick="forceInitSpeech()">üöÄ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <button onclick="testBasicSpeech()">üé§ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</button>
            <button onclick="testThaiSpeech()">üó£Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ó‡∏¢</button>
            <button onclick="callQueueForced()">üì¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</button>
        </div>
        
        <div class="controls">
            <button onclick="listAllVoices()">üìã ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="tryDifferentVoices()">üîÑ ‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏∑‡πà‡∏ô</button>
            <button onclick="forceReload()">üîÅ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <button onclick="stopAll()">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status" class="status info">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á" ‡∏Å‡πà‡∏≠‡∏ô</div>
        
        <div id="voiceInfo" class="voice-info">
            <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á:</strong> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
        </div>
        
        <div id="debug" class="debug">
=== DEBUG LOG ===<br>
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...
        </div>
    </div>

    <script>
        // Global variables
        let speechSynthesis = window.speechSynthesis;
        let allVoices = [];
        let selectedVoice = null;
        let isInitialized = false;
        let debugLog = [];
        let testIndex = 0;

        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            
            if (debugLog.length > 50) {
                debugLog = debugLog.slice(-50);
            }
            
            document.getElementById('debug').innerHTML = 
                '=== DEBUG LOG ===<br>' + debugLog.join('<br>');
            
            console.log(logMessage);
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            log(`STATUS: ${message}`, type);
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à');
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
            
            // Auto-focus input
            document.getElementById('queueInput').focus();
            
            // Try to load voices immediately
            setTimeout(loadVoicesAggressively, 500);
        });

        async function forceInitSpeech() {
            log('üéµ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö...');
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á...', 'info');
            updateProgress(10);

            try {
                // Step 1: Force speech synthesis wake up
                log('üì¢ ‡∏õ‡∏•‡∏∏‡∏Å Speech Synthesis...');
                speechSynthesis.cancel();
                
                // Create dummy utterance to wake up the system
                const dummyUtterance = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(dummyUtterance);
                speechSynthesis.cancel();
                
                updateProgress(30);
                await new Promise(resolve => setTimeout(resolve, 200));

                // Step 2: Force load voices
                log('üîÑ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...');
                await loadVoicesAggressively();
                updateProgress(60);

                // Step 3: Test basic functionality
                log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô...');
                const testResult = await testSpeechCapability();
                updateProgress(80);

                if (testResult) {
                    log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');
                    showStatus('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!', 'success');
                    isInitialized = true;
                } else {
                    log('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    showStatus('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'warning');
                }

                updateProgress(100);
                setTimeout(() => updateProgress(0), 2000);

            } catch (error) {
                log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        async function loadVoicesAggressively() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 10;

                function tryLoadVoices() {
                    attempts++;
                    allVoices = speechSynthesis.getVoices();
                    log(`üîç ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${attempts}: ‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${allVoices.length} ‡πÄ‡∏™‡∏µ‡∏¢‡∏á`);

                    if (allVoices.length > 0) {
                        selectBestVoice();
                        updateVoiceInfo();
                        resolve(true);
                        return;
                    }

                    if (attempts < maxAttempts) {
                        setTimeout(tryLoadVoices, 200);
                    } else {
                        log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° ' + attempts + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                        resolve(false);
                    }
                }

                // Listen for voice changes
                speechSynthesis.addEventListener('voiceschanged', () => {
                    log('üîÑ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
                    tryLoadVoices();
                });

                // Start loading
                tryLoadVoices();

                // Force voice loading for stubborn browsers
                setTimeout(() => {
                    if (allVoices.length === 0) {
                        log('üî® ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏•‡∏∏‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...');
                        speechSynthesis.speak(new SpeechSynthesisUtterance('wake up'));
                        speechSynthesis.cancel();
                        setTimeout(tryLoadVoices, 100);
                    }
                }, 1000);
            });
        }

        function selectBestVoice() {
            if (allVoices.length === 0) {
                log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                return;
            }

            // Priority order for Thai voices
            const thaiVoices = allVoices.filter(voice => 
                voice.lang.includes('th') || 
                voice.lang.includes('TH') ||
                voice.name.includes('Thai') ||
                voice.name.includes('‡∏Å‡∏±‡∏ô‡∏¢‡∏≤') ||
                voice.name.includes('Kanya')
            );

            if (thaiVoices.length > 0) {
                selectedVoice = thaiVoices[0];
                log(`‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ó‡∏¢: ${selectedVoice.name} (${selectedVoice.lang})`);
            } else {
                // Fallback to English or any voice
                const englishVoices = allVoices.filter(voice => 
                    voice.lang.includes('en')
                );
                
                selectedVoice = englishVoices[0] || allVoices[0];
                log(`‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á: ${selectedVoice.name} (${selectedVoice.lang})`);
            }
        }

        function updateVoiceInfo() {
            const info = document.getElementById('voiceInfo');
            
            if (selectedVoice) {
                info.innerHTML = `
                    <strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong> ${selectedVoice.name}<br>
                    <strong>‡∏†‡∏≤‡∏©‡∏≤:</strong> ${selectedVoice.lang}<br>
                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${allVoices.length} ‡πÄ‡∏™‡∏µ‡∏¢‡∏á<br>
                    <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: #2ecc71;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                `;
            } else {
                info.innerHTML = `
                    <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: #e74c3c;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span><br>
                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${allVoices.length} ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                `;
            }
        }

        async function testSpeechCapability() {
            if (!selectedVoice) {
                log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                return false;
            }

            return new Promise((resolve) => {
                log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î...');
                
                const utterance = new SpeechSynthesisUtterance('test');
                utterance.voice = selectedVoice;
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1;

                let hasStarted = false;
                let hasEnded = false;

                utterance.onstart = () => {
                    hasStarted = true;
                    log('‚úÖ ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                };

                utterance.onend = () => {
                    hasEnded = true;
                    log('‚úÖ ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    resolve(true);
                };

                utterance.onerror = (event) => {
                    log('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î: ' + event.error);
                    resolve(false);
                };

                try {
                    speechSynthesis.speak(utterance);
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (!hasEnded) {
                            log('‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö (5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)');
                            speechSynthesis.cancel();
                            resolve(hasStarted);
                        }
                    }, 5000);
                    
                } catch (error) {
                    log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ: ' + error.message);
                    resolve(false);
                }
            });
        }

        async function testBasicSpeech() {
            if (!isInitialized) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }

            log('üé§ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô...');
            showStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô...', 'info');

            await forcedSpeak('Hello, this is a test', 'en-US');
        }

        async function testThaiSpeech() {
            if (!isInitialized) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }

            log('üó£Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢...');
            showStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢...', 'info');

            await forcedSpeak('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', 'th-TH');
        }

        async function callQueueForced() {
            const queueNumber = document.getElementById('queueInput').value.trim();
            
            if (!queueNumber) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß', 'error');
                return;
            }

            if (!isInitialized) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }

            try {
                log(`üì¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${queueNumber} (‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)`);
                showStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${queueNumber}...`, 'info');
                
                // Update display
                const display = document.getElementById('queueDisplay');
                display.textContent = queueNumber;
                display.classList.add('pulse');

                // Speak queue number
                const message = `‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${queueNumber} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö`;
                await forcedSpeak(message, 'th-TH');

                showStatus(`‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${queueNumber} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                log(`‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${queueNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);

                // Auto increment
                const nextQueue = parseInt(queueNumber) + 1;
                document.getElementById('queueInput').value = nextQueue;

                setTimeout(() => {
                    display.classList.remove('pulse');
                }, 3000);

            } catch (error) {
                log(`‚ùå ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß', 'error');
            }
        }

        async function forcedSpeak(text, language = 'th-TH') {
            return new Promise((resolve) => {
                log(`üó£Ô∏è ‡∏û‡∏π‡∏î: "${text}" (${language})`);

                // Cancel any ongoing speech
                speechSynthesis.cancel();

                // Wait a bit after cancel
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Voice selection
                    if (language === 'th-TH') {
                        utterance.voice = selectedVoice;
                    } else {
                        const englishVoice = allVoices.find(v => v.lang.includes('en'));
                        utterance.voice = englishVoice || selectedVoice;
                    }

                    // Settings
                    utterance.volume = 1.0;
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    utterance.lang = language;

                    let hasStarted = false;
                    let hasEnded = false;

                    utterance.onstart = () => {
                        hasStarted = true;
                        log('üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î');
                        showStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î: ${text.substring(0, 30)}...`, 'info');
                    };

                    utterance.onend = () => {
                        hasEnded = true;
                        log('‚úÖ ‡∏û‡∏π‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à');
                        showStatus('‡∏û‡∏π‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        resolve(true);
                    };

                    utterance.onerror = (event) => {
                        log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${event.error}`);
                        showStatus(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${event.error}`, 'error');
                        resolve(false);
                    };

                    try {
                        speechSynthesis.speak(utterance);
                        log('üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î...');

                        // Fallback timeout
                        setTimeout(() => {
                            if (!hasEnded) {
                                log('‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î');
                                speechSynthesis.cancel();
                                resolve(hasStarted);
                            }
                        }, 15000);

                    } catch (error) {
                        log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ: ${error.message}`);
                        resolve(false);
                    }
                }, 100);
            });
        }

        function listAllVoices() {
            log('üìã ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:');
            
            if (allVoices.length === 0) {
                log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
                showStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error');
                return;
            }

            allVoices.forEach((voice, index) => {
                const isSelected = voice === selectedVoice ? ' ‚≠ê' : '';
                log(`${index + 1}. ${voice.name} (${voice.lang})${isSelected}`);
            });

            showStatus(`‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${allVoices.length} ‡πÄ‡∏™‡∏µ‡∏¢‡∏á`, 'info');
        }

        async function tryDifferentVoices() {
            if (allVoices.length === 0) {
                showStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'error');
                return;
            }

            log('üîÑ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ...');
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ...', 'info');

            for (let i = 0; i < Math.min(allVoices.length, 5); i++) {
                const voice = allVoices[i];
                log(`üé§ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${voice.name} (${voice.lang})`);
                
                selectedVoice = voice;
                updateVoiceInfo();
                
                await forcedSpeak(`‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${voice.name}`, voice.lang.includes('th') ? 'th-TH' : 'en-US');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        function forceReload() {
            log('üîÅ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á...');
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á...', 'info');
            
            isInitialized = false;
            allVoices = [];
            selectedVoice = null;
            
            speechSynthesis.cancel();
            setTimeout(forceInitSpeech, 500);
        }

        function stopAll() {
            log('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á');
            speechSynthesis.cancel();
            showStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'info');
            updateProgress(0);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName !== 'INPUT') {
                if (e.code === 'Space') {
                    e.preventDefault();
                    callQueueForced();
                }
                if (e.key === 'Escape') {
                    stopAll();
                }
                if (e.key === 'Enter') {
                    callQueueForced();
                }
            }
        });

        // Enter in input
        document.getElementById('queueInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                callQueueForced();
            }
        });
    </script>
</body>
</html>